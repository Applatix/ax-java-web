---
type: service_template
subtype: workflow
name: Applatix jmeter test dynamic fixture
description: Jmeter test demo with dynamic fixtures. 
fixtures:
  - tomcat-postgres:
      template: tomcat-postgres
    jmeter-slave1:
      template: jmeter-slave1
    jmeter-slave2:
      template: jmeter-slave2
    jmeter-slave3:
      template: jmeter-slave3     
inputs:
  parameters:
    commit:
      default: "%%session.commit%%"
    repo:
      default: "%%session.repo%%"
    iterations:
      default: 1
steps:
  - checkout:
      template: axscm-checkout
  - jmeter-test:
      template: jmeter-test
      parameters:
        code: "%%steps.checkout.code%%"
        tomcat_ip: "%%fixtures.tomcat-postgres.ip%%"
        slave1_ip: "%%fixtures.jmeter-slave1.ip%%"
        slave2_ip: "%%fixtures.jmeter-slave2.ip%%"
        slave3_ip: "%%fixtures.jmeter-slave3.ip%%"

---
type: service_template
subtype: container
name: jmeter-test
description: run test against the tomcat server
container:
  image: applatix/jmeter-master
  resources:
    mem_mib: 512
    cpu_cores: 0.2
  command: sh -c "sh /src/run.sh --tomcat_ip %%tomcat_ip%% --slave1_ip %%slave1_ip%% --slave2_ip %%slave2_ip%% --slave3_ip %%slave3_ip%%"
inputs:
  parameters:
    code:
    redis_ip:
    mongodb_ip:
    iterations:
  artifacts:
  - from: "%%code%%"
    path: "/src"

---
type: service_template
subtype: container
name: tomcat-postgres
description: tomcat-postgres container
container:
  image: applatix/tomcat-postgres
  resources:
    mem_mib: 512
    cpu_cores: 0.2

---
type: service_template
subtype: container
name: jmeter-slave
description: jmeter-slave container
container:
  image: applatix/jmeter-server
  resources:
    mem_mib: 256
    cpu_cores: 0.1

---
type: service_template
subtype: container
name: jmeter-slave
description: jmeter-slave container
container:
  image: applatix/jmeter-server
  resources:
    mem_mib: 256
    cpu_cores: 0.1

---
type: service_template
subtype: container
name: jmeter-slave
description: jmeter-slave container
container:
  image: applatix/jmeter-server
  resources:
    mem_mib: 256
    cpu_cores: 0.1
